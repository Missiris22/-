# 项目中出现的问题

## vue路由不可以传递对象

1. 效果

- 数字类型将变成string类型
- 数组类型传递出错（数组中存picList，upload组件报错，认为传递过来的为string）
=》 路由传递对象收到的是string类型
[] 9
2. 处理方案

1） 使用 `JSON.stringify` 处理传递的数据
2） 使用 `JSON.parse` 处理收到的数据

```js
this.$router.push({
    path: '/source/path',
    query: {
        row: JSON.stringify(row) // row [Object]
    }
})

// ------
const row = JSON.parse(this.$router.query.row)
```

## 前端存储大数据量

1. 项目要求：
批量实现图片转视频，后端不需要存储确认生成视频之前的中间态（即图片转视频和编辑视频的中间过程），所以需要前端暂存视频。而且由于需要批量转视频，最多50ge，故需要找一个前端数据库

2. 实现
使用indexDb数据库。`Application` 里 `sessionstorage` 同级数据库下增加 `indexDb`

```js
// indexDb.js
const DB_VERSION = 1;
const DB_NAME = 'Pic';
const storeName = 'noPicTable';

// 打开数据库 / 新建数据库、创建对象仓库
function openDb() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onsuccess = function (event) {
            console.log('数据库打开成功');
            resolve(event);
        };

        request.onerror = function (event) {
            alert(`数据库打开报错：${event.target.errorCode}`);
            reject(event);
        };

        request.onupgradeneeded = function (event) {
            const store = event.target.result;
            const objectStore = store.createObjectStore(storeName, { keyPath: 'itemsId' });
            objectStore.createIndex('itemsId', 'itemsId', { unique: true });
            objectStore.createIndex('itemsName', 'itemsName', { unique: false });
            objectStore.createIndex('parentIpName', 'parentIpName', { unique: false });
            objectStore.createIndex('cateName', 'cateName', { unique: false });
            objectStore.createIndex('imgs', 'imgs', { unique: false });
            objectStore.createIndex('onSaleTime', 'onSaleTime', { unique: false });
            objectStore.createIndex('videoUrl', 'videoUrl', { unique: false });
            objectStore.createIndex('isChecked', 'isChecked', { unique: false });
        };
    });
}

// 写入数据
function addData(data) {
    // 打开数据库
    return openDb().then(event => {
        const db = event.target.result;
        const transaction = db.transaction([storeName], 'readwrite');
        const VideoObjectStore = transaction.objectStore(storeName);
        if (Array.isArray(data)) {
            data.forEach(item => {
                VideoObjectStore.add(item);
            });
        }
        else {
            VideoObjectStore.add(data);
        }
        return Promise.resolve();
    }).catch(() => {
        alert('数据写入失败，请重新点击“批量生成视频”按钮！');
        return Promise.reject();
    });
}

// 修改数据
function editData(arr) {
    // 打开数据库
    return openDb().then(event => {
        const db = event.target.result;
        const transaction = db.transaction([storeName], 'readwrite');
        const VideoObjectStore = transaction.objectStore(storeName);
        arr.forEach(item => {
            VideoObjectStore.put(item);
        });
        return Promise.resolve();
    }).catch(() => {
        alert('数据写入失败，请重新点击“批量生成视频”按钮！');
        return Promise.reject();
    });
}

// 读取数据（查询单个数据）
function readData(id) {
    // 打开数据库
    return openDb().then(event => {
        const db = event.target.result;
        const rs = db.transaction([storeName], 'readwrite').objectStore(storeName).get(id);
        return Promise.resolve(rs);
    }).catch(() => {
        alert('获取数据失败，请重试！');
        return Promise.reject();
    });
}

// 游标读取所有数据
function getData() {
    // 打开数据库
    return new Promise((resolve, reject) => {
        openDb().then(event => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(storeName)) {
                reject('err');
                return;
            }
            const transaction = db.transaction([storeName], 'readwrite');
            const VideoObjectStore = transaction.objectStore(storeName);
            const rs = VideoObjectStore.openCursor();
            const table = [];
            rs.onsuccess = function (e) {
                const cursor = e.target.result;
                if (cursor) {
                    table.push(Object.assign(cursor.value));
                    cursor.continue();
                }
                if (!cursor) {
                    resolve(table);
                }
            };
            rs.onerror = function (e) {
                reject(e);
            };
        });
    });
}

// 删除数据
function deleteData(id) {
    // 打开数据库
    return openDb().then(event => {
        const db = event.target.result;
        const transaction = db.transaction([storeName], 'readwrite');
        const VideoObjectStore = transaction.objectStore(storeName);
        VideoObjectStore.delete(id);
        return Promise.resolve();
    }).catch(() => {
        alert('删除数据失败，请重试！');
        return Promise.reject();
    });
}

// 清空对象仓库
function clearStore() {
    // 打开数据库
    return openDb().then(event => {
        const db = event.target.result;
        const transaction = db.transaction([storeName], 'readwrite');
        const VideoObjectStore = transaction.objectStore(storeName);
        VideoObjectStore.clear();
        return Promise.resolve();
    }).catch(() => {
        alert('清空数据失败，请返回审核！');
        return Promise.reject();
    });
}

// 判断store是否存在
function ifDbExist() {
    return openDb().then(event => {
        const store = event.target.result;
        if (!store.objectStoreNames.contains(storeName)) {
            return Promise.reject();
        }
        return Promise.resolve();
    });
}

export default {
    openDb,
    addData,
    readData,
    editData,
    getData,
    deleteData,
    clearStore,
    ifDbExist
};

```
